name: Test Devcontainers

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-nextjs:
    name: Test Next.js Variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Next.js devcontainer
        run: |
          cd .devcontainer
          docker build \
            --build-arg VARIANT=nextjs-shadcn \
            --build-arg NODE_VERSION=20 \
            -f Dockerfile \
            -t devcontainer-nextjs:test \
            --target nextjs-shadcn \
            .

      - name: Test Next.js setup script
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            devcontainer-nextjs:test \
            bash -c "cd nextjs-shadcn && bun --version"

  test-go:
    name: Test Go Variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Go devcontainer
        run: |
          cd .devcontainer
          docker build \
            --build-arg VARIANT=go \
            --build-arg GO_VERSION=1.21 \
            -f Dockerfile \
            -t devcontainer-go:test \
            --target go \
            .

      - name: Test Go installation
        run: |
          docker run --rm \
            devcontainer-go:test \
            bash -c "go version && go env"

      - name: Test Go tools
        run: |
          docker run --rm \
            devcontainer-go:test \
            bash -c "which gopls && which dlv"

  test-python:
    name: Test Python Variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Python devcontainer
        run: |
          cd .devcontainer
          docker build \
            --build-arg VARIANT=python \
            --build-arg PYTHON_VERSION=3.11 \
            -f Dockerfile \
            -t devcontainer-python:test \
            --target python \
            .

      - name: Test Python installation
        run: |
          docker run --rm \
            devcontainer-python:test \
            bash -c "python3 --version && pip --version"

      - name: Test Python tools
        run: |
          docker run --rm \
            devcontainer-python:test \
            bash -c "python3 -m black --version && python3 -m pylint --version"

  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate devcontainer.json
        uses: devcontainers/ci@v0.3
        with:
          runCmd: echo "Devcontainer configuration is valid"

      - name: Check shell scripts syntax
        run: |
          bash -n .devcontainer/setup-nextjs-shadcn.sh
          bash -n .devcontainer/setup-go.sh
          bash -n .devcontainer/setup-python.sh

      - name: Validate JSON files
        run: |
          cat .devcontainer/devcontainer.json | jq empty
          cat nextjs-shadcn/package.json | jq empty
          cat nextjs-shadcn/tsconfig.json | jq empty
          cat nextjs-shadcn/config/components.json | jq empty

  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: .devcontainer/Dockerfile
          failure-threshold: warning

  test-laravel:
    name: Test Laravel Variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Laravel devcontainer
        run: |
          cd .devcontainer
          docker build \
            --build-arg VARIANT=laravel \
            --build-arg PHP_VERSION=8.2 \
            -f Dockerfile \
            -t devcontainer-laravel:test \
            --target laravel \
            .

      - name: Test PHP installation
        run: |
          docker run --rm \
            devcontainer-laravel:test \
            bash -c "php -v && composer --version"

      - name: Test Laravel CLI
        run: |
          docker run --rm \
            devcontainer-laravel:test \
            bash -c "laravel --version || echo 'Laravel installer available'"

  check-markdown:
    name: Check Markdown Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          config: ".markdownlint.json"
          args: "**/*.md"
          ignore: "node_modules"
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true
